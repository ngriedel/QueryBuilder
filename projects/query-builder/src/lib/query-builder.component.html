<div [ngClass]="getClassNames('switchRow')">

  <ng-template #primengArrowIcon>
    <i class="pi pi-chevron-right"></i>
  </ng-template>

  @if (allowCollapse) {
    <a (click)="toggleCollapse()" [ngClass]="getClassNames('arrowIconButton', data.collapsed ? 'collapsed' : null)">
      @if (getArrowIconTemplate(); as template) {
        <ng-container *ngTemplateOutlet="template; context: getArrowIconContext()"></ng-container>
      } @else {
        @if (usePrimengControls) {
          <ng-container *ngTemplateOutlet="primengArrowIcon; context: getArrowIconContext()"></ng-container>
        } @else {
          <i [ngClass]="getClassNames('arrowIcon')"></i>
        }
      }
    </a>
  }

  @if (getButtonGroupTemplate(); as template) {
    <div [ngClass]="getClassNames('buttonGroup', 'rightAlign')">
      <ng-container *ngTemplateOutlet="template; context: getButtonGroupContext()"></ng-container>
    </div>
  } @else {
    @if (usePrimengControls) {
      <ng-container *ngTemplateOutlet="primengButtonGroup; context: getButtonGroupContext()"></ng-container>
    } @else {
      <div [ngClass]="getClassNames('buttonGroup', 'rightAlign')">
        <button type="button" (click)="addRule()" [ngClass]="getClassNames('button')" [disabled]="disabled"><i
          [ngClass]="getClassNames('addIcon')"></i> Rule
        </button>
        @if (allowRuleset) {
          <button type="button" (click)="addRuleSet()" [ngClass]="getClassNames('button')" [disabled]="disabled"><i
            [ngClass]="getClassNames('addIcon')"></i> Ruleset
          </button>
        }
        @if (!!parentValue && allowRuleset) {
          <button type="button" (click)="removeRuleSet()" [ngClass]="getClassNames('button', 'removeButton')"
                  [disabled]="disabled">
            <i [ngClass]="getClassNames('removeIcon')"></i>
          </button>
        }
      </div>
    }
  }


  <ng-template #primengButtonGroup let-ruleset let-addRule="addRule" let-addRuleSet="addRuleSet"
               let-removeRuleSet="removeRuleSet">
    <div class="flex space-x-2">
      <p-button icon="pi pi-plus" styleClass="p-button-rounded p-button-primary p-button-sm" [disabled]="disabled"
                (onClick)="addRule()"></p-button>
      @if (addRuleSet) {
        <p-button icon="pi pi-plus-circle" styleClass="p-button-rounded p-button-primary p-button-sm"
                  [disabled]="disabled" (onClick)="addRuleSet()"></p-button>
      }
      @if (removeRuleSet) {
        <p-button icon="pi pi-minus-circle" styleClass="p-button-rounded p-button-danger p-button-sm"
                  [disabled]="disabled" (onClick)="removeRuleSet()"></p-button>
      }
    </div>
  </ng-template>


  @if (getSwitchGroupTemplate(); as template) {
    <ng-container *ngTemplateOutlet="template; context: getSwitchGroupContext()"></ng-container>
  } @else {
    @if (usePrimengControls) {
      <ng-container *ngTemplateOutlet="primengSwitchGroup; context: getSwitchGroupContext()"></ng-container>
    } @else {
      @if (data) {
        <div [ngClass]="getClassNames('switchGroup', 'transition')">
          <div [ngClass]="getClassNames('switchControl')">
            <input type="radio" [ngClass]="getClassNames('switchRadio')" [(ngModel)]="data.condition"
                   [disabled]="disabled"
                   value="and" #andOption />
            <label (click)="changeCondition(andOption.value)" [ngClass]="getClassNames('switchLabel')">AND</label>
          </div>
          <div [ngClass]="getClassNames('switchControl')">
            <input type="radio" [ngClass]="getClassNames('switchRadio')" [(ngModel)]="data.condition"
                   [disabled]="disabled"
                   value="or" #orOption />
            <label (click)="changeCondition(orOption.value)" [ngClass]="getClassNames('switchLabel')">OR</label>
          </div>
        </div>
      }
    }
  }


  <ng-template #primengSwitchGroup let-ruleset let-onChange="onChange">
    @if (ruleset) {
      <div class="flex items-center space-x-4 py-2">
        <div class="flex items-center">
          <p-radioButton name="condition{{ruleset}}" [value]="'and'" [(ngModel)]="ruleset.condition"
                         [disabled]="disabled"
                         (onClick)="onChange('and')"></p-radioButton>
          <label class="ml-2 font-medium">And</label>
        </div>
        <div class="flex items-center">
          <p-radioButton name="condition{{ruleset}}" [value]="'or'" [(ngModel)]="ruleset.condition"
                         [disabled]="disabled"
                         (onClick)="onChange('or')"></p-radioButton>
          <label class="ml-2 font-medium">Or</label>
        </div>
      </div>
    }
  </ng-template>

</div>

<div #treeContainer (transitionend)="transitionEnd($event)"
     [ngClass]="getClassNames('treeContainer', data.collapsed ? 'collapsed' : null)">
  @if (data && data.rules) {
    <ul [ngClass]="getClassNames('tree')">
      @for (rule of data.rules; track rule; let i = $index) {
        @if ({ ruleset: !!rule.rules, invalid: !config.allowEmptyRulesets && rule.rules && rule.rules.length === 0 }; as
          local) {
          <li [ngClass]="getQueryItemClassName(local)">
            @if (!local.ruleset) {
              @if (getRemoveButtonTemplate(); as template) {
                <div [ngClass]="getClassNames('buttonGroup', 'rightAlign')">
                  <ng-container *ngTemplateOutlet="template; context: getRemoveButtonContext(rule)"></ng-container>
                </div>
              } @else {
                @if (usePrimengControls) {
                  <ng-container
                    *ngTemplateOutlet="primengRemoveButton; context: getRemoveButtonContext(rule)"></ng-container>
                } @else {
                  <div [ngClass]="getClassNames('removeButtonSize', 'rightAlign')">
                    <button type="button" [ngClass]="getClassNames('button', 'removeButton')"
                            (click)="removeRule(rule, data)"
                            [disabled]="disabled">
                      <i [ngClass]="getClassNames('removeIcon')"></i>
                    </button>
                  </div>
                }
              }
              <ng-template #primengRemoveButton let-rule let-removeRule="removeRule">
                <div [ngClass]="getClassNames('removeButtonSize', 'rightAlign')">
                  <p-button icon="pi pi-minus" styleClass="p-button-rounded p-button-danger p-button-sm"
                            [disabled]="disabled"
                            (onClick)="removeRule(rule)"></p-button>
                </div>
              </ng-template>
              @if (entities?.length > 0) {
                <div class="q-inline-block-display">
                  @if (getEntityTemplate(); as template) {
                    <ng-container *ngTemplateOutlet="template; context: getEntityContext(rule)"></ng-container>
                  } @else {
                    @if (usePrimengFields) {
                      <ng-container *ngTemplateOutlet="primengEntity; context: getEntityContext(rule)"></ng-container>
                    } @else {
                      <div [ngClass]="getClassNames('entityControlSize')">
                        <select [ngClass]="getClassNames('entityControl')" [(ngModel)]="rule.entity"
                                (ngModelChange)="changeEntity($event, rule, i, data)" [disabled]="disabled">
                          @for (entity of entities; track entity) {
                            <option [ngValue]="entity.value">
                              {{ entity.name }}
                            </option>
                          }
                        </select>
                      </div>
                    }
                  }
                </div>
              }
              <ng-template #primengEntity let-rule let-entities="entities" let-onChange="onChange">
                <div [ngClass]="getClassNames('entityControlSize')">
                  <p-select [appendTo]="'body'" [options]="entities" [(ngModel)]="rule.entity"
                            (onChange)="onChange($event.value, rule)" [disabled]="disabled" optionLabel="name"
                            optionValue="value"
                            styleClass="w-full md:w-48">
                  </p-select>
                </div>
              </ng-template>
              @if (getFieldTemplate(); as template) {
                <ng-container *ngTemplateOutlet="template; context: getFieldContext(rule)"></ng-container>
              } @else {
                @if (usePrimengFields) {
                  <ng-container *ngTemplateOutlet="primengField; context: getFieldContext(rule)"></ng-container>
                } @else {
                  <div [ngClass]="getClassNames('fieldControlSize')">
                    <select [ngClass]="getClassNames('fieldControl')" [(ngModel)]="rule.field"
                            (ngModelChange)="changeField($event, rule)" [disabled]="disabled">
                      @for (field of getFields(rule.entity); track field) {
                        <option [ngValue]="field.value">
                          {{ field.name }}
                        </option>
                      }
                    </select>
                  </div>
                }
              }
              <ng-template #primengField let-rule let-getFields="getFields">
                <div [ngClass]="getClassNames('fieldControlSize')">
                  <p-select [appendTo]="'body'" [options]="getFields(rule.entity)" [(ngModel)]="rule.field"
                            (onChange)="changeField($event.value, rule)" [disabled]="disabled" optionLabel="name"
                            optionValue="value"
                            styleClass="w-full md:w-48">
                  </p-select>
                </div>
              </ng-template>
              @if (getOperatorTemplate(); as template) {
                <ng-container *ngTemplateOutlet="template; context: getOperatorContext(rule)"></ng-container>
              } @else {
                @if (usePrimengFields) {
                  <ng-container *ngTemplateOutlet="primengOperator; context: getOperatorContext(rule)"></ng-container>
                } @else {
                  <div [ngClass]="getClassNames('operatorControlSize')">
                    <select [title]="getOperatorHintSelect(rule)" [ngClass]="getClassNames('operatorControl')"
                            [(ngModel)]="rule.operator" (ngModelChange)="changeOperator(rule)" [disabled]="disabled">
                      @for (operator of getOperators(rule.field); track operator) {
                        <option [title]="getOperatorHint(operator)" [ngValue]="getOperatorDisplay(operator)">
                          {{ getOperatorDisplay(operator) }}
                        </option>
                      }
                    </select>
                  </div>
                }
              }
              <ng-template #primengOperator let-rule>
                <div [ngClass]="getClassNames('operatorControlSize')">
                  <p-select [appendTo]="'body'" [options]="getOperatorsForPrimeng(rule.field)"
                            [(ngModel)]="rule.operator"
                            (onChange)="changeOperator(rule)" [disabled]="disabled" optionLabel="label"
                            optionValue="value"
                            styleClass="w-28">
                    <ng-template pTemplate="item" let-option>
                      <span [pTooltip]="option.hint">{{ option.label }}</span>
                    </ng-template>
                    <ng-template pTemplate="selectedItem" let-option>
                      <span [pTooltip]="option.hint" [title]="option.hint">{{ option.label }}</span>
                    </ng-template>
                  </p-select>
                </div>
              </ng-template>
              @if (findTemplateForRule(rule); as template) {
                <ng-container *ngTemplateOutlet="template; context: getInputContext(rule)"></ng-container>
              } @else {
                @if (usePrimengInputs) {
                  <ng-container *ngTemplateOutlet="primengInput; context: getInputContext(rule)"></ng-container>
                } @else {
                  <div [ngClass]="getClassNames('inputControlSize')">
                    @switch (getInputType(rule.field, rule.operator)) {
                      @case ('string') {
                        <input [ngClass]="getClassNames('inputControl')" [(ngModel)]="rule.value"
                               (ngModelChange)="changeInput()"
                               [disabled]="disabled" type="text" />
                      }
                      @case ('number') {
                        <input [ngClass]="getClassNames('inputControl')" [(ngModel)]="rule.value"
                               (ngModelChange)="changeInput()"
                               [disabled]="disabled" type="number" />
                      }
                      @case ('date') {
                        <input [ngClass]="getClassNames('inputControl')" [(ngModel)]="rule.value"
                               (ngModelChange)="changeInput()"
                               [disabled]="disabled" type="date" />
                      }
                      @case ('time') {
                        <input [ngClass]="getClassNames('inputControl')" [(ngModel)]="rule.value"
                               (ngModelChange)="changeInput()"
                               [disabled]="disabled" type="time" />
                      }
                      @case ('category') {
                        <select [ngClass]="getClassNames('inputControl')" [(ngModel)]="rule.value"
                                (ngModelChange)="changeInput()"
                                [disabled]="disabled">
                          @for (opt of getOptions(rule.field); track opt) {
                            <option [ngValue]="opt.value">
                              {{ opt.name }}
                            </option>
                          }
                        </select>
                      }
                      @case ('multiselect') {
                        <select [ngClass]="getClassNames('inputControl')" [(ngModel)]="rule.value"
                                (ngModelChange)="changeInput()"
                                [disabled]="disabled" multiple>
                          @for (opt of getOptions(rule.field); track opt) {
                            <option [ngValue]="opt.value">
                              {{ opt.name }}
                            </option>
                          }
                        </select>
                      }
                      @case ('boolean') {
                        <input [ngClass]="getClassNames('inputControl')" [(ngModel)]="rule.value"
                               (ngModelChange)="changeInput()"
                               [disabled]="disabled" type="checkbox" />
                      }
                    }
                  </div>
                }
              }
              <ng-template #primengInput let-rule let-field="field" let-options="options">
                <div [ngClass]="getClassNames('inputControlSize')">
                  @switch (getInputType(rule.field, rule.operator)) {
                    <!-- String Input -->
                    @case ('string') {
                      <input pInputText [(ngModel)]="rule.value" (input)="changeInput()" [disabled]="disabled"
                             class="w-full md:w-64" />
                    }
                    <!-- Number Input -->
                    @case ('number') {
                      <p-inputNumber [(ngModel)]="rule.value" (onInput)="changeInput()" [disabled]="disabled"
                                     styleClass="w-32"></p-inputNumber>
                    }
                    <!-- Date Input -->
                    @case ('date') {
                      <p-datePicker [(ngModel)]="rule.value" [appendTo]="'body'" (onSelect)="changeInput()"
                                    [disabled]="disabled"
                                    styleClass="w-full md:w-auto"></p-datePicker>
                    }
                    <!-- Time Input (fallback to regular input) -->
                    @case ('time') {
                      <input pInputText [(ngModel)]="rule.value" (input)="changeInput()" [disabled]="disabled"
                             type="time"
                             class="w-full md:w-auto" />
                    }
                    <!-- Category (Dropdown) -->
                    @case ('category') {
                      <p-select [appendTo]="'body'" [options]="getOptions(rule.field)" [(ngModel)]="rule.value"
                                (onChange)="changeInput()" [disabled]="disabled" optionLabel="name" optionValue="value"
                                styleClass="w-full md:w-48"></p-select>
                    }
                    <!-- Multiselect -->
                    @case ('multiselect') {
                      <p-multiSelect [appendTo]="'body'" [options]="getOptions(rule.field)" [(ngModel)]="rule.value"
                                     (onChange)="changeInput()" [disabled]="disabled" optionLabel="name"
                                     optionValue="value"
                                     styleClass="w-full md:w-64"></p-multiSelect>
                    }
                    <!-- Boolean (Dropdown) -->
                    @case ('boolean') {
                      <p-select [appendTo]="'body'"
                                [options]="[{label: 'True', value: true}, {label: 'False', value: false}]"
                                [(ngModel)]="rule.value" (onChange)="changeInput()" [disabled]="disabled"
                                optionLabel="label"
                                optionValue="value" styleClass="w-32"></p-select>
                    }
                  }
                </div>
              </ng-template>
            }
            @if (local.ruleset) {
              <query-builder [data]="rule" [disabled]="disabled"
                             [parentTouchedCallback]="parentTouchedCallback || onTouchedCallback"
                             [parentChangeCallback]="parentChangeCallback || onChangeCallback"
                             [parentInputTemplates]="parentInputTemplates || inputTemplates"
                             [parentOperatorTemplate]="parentOperatorTemplate || operatorTemplate"
                             [parentFieldTemplate]="parentFieldTemplate || fieldTemplate"
                             [parentEntityTemplate]="parentEntityTemplate || entityTemplate"
                             [parentSwitchGroupTemplate]="parentSwitchGroupTemplate || switchGroupTemplate"
                             [parentButtonGroupTemplate]="parentButtonGroupTemplate || buttonGroupTemplate"
                             [parentRemoveButtonTemplate]="parentRemoveButtonTemplate || removeButtonTemplate"
                             [parentEmptyWarningTemplate]="parentEmptyWarningTemplate || emptyWarningTemplate"
                             [parentArrowIconTemplate]="parentArrowIconTemplate || arrowIconTemplate"
                             [parentValue]="data"
                             [classNames]="classNames" [config]="config" [allowRuleset]="allowRuleset"
                             [allowCollapse]="allowCollapse"
                             [emptyMessage]="emptyMessage" [operatorMap]="operatorMap"
                             [usePrimengFields]="usePrimengFields"
                             [usePrimengControls]="usePrimengControls" [usePrimengInputs]="usePrimengInputs">
              </query-builder>
            }
            @if (getEmptyWarningTemplate(); as template) {
              @if (local.invalid) {
                <ng-container *ngTemplateOutlet="template; context: getEmptyWarningContext()"></ng-container>
              }
            } @else {
              @if (local.invalid) {
                <p [ngClass]="getClassNames('emptyWarning')">
                  {{ emptyMessage }}
                </p>
              }
            }
          </li>
        }
      }
    </ul>
  }
</div>
